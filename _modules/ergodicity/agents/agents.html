<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ergodicity.agents.agents &#8212; Ergodicity Library 0.3.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../_static/documentation_options.js?v=e259d695"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ergodicity.agents.agents</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">agents Submodule Overview</span>

<span class="sd">The **`agents`** module focuses on creating and managing economic agents that optimize their utility functions over time in a stochastic environment. It provides various algorithms and tools for simulating agent behavior, evolving utility functions, and running multi-agent evolutionary processes. These agents interact with multiple stochastic processes, making decisions based on expected utility and wealth maximization.</span>

<span class="sd">Key Features:</span>

<span class="sd">1. **Utility Functions**:</span>

<span class="sd">   - Each agent uses a general utility function parameterized by alpha, beta, gamma, delta, and epsilon.</span>

<span class="sd">   - Utility functions are used to calculate the expected utility from various stochastic processes.</span>

<span class="sd">2. **Expected Utility**:</span>

<span class="sd">   - The module allows agents to calculate expected utility either numerically (via process simulations) or symbolically (via integral approximations).</span>

<span class="sd">3. **Evolutionary Algorithms**:</span>

<span class="sd">   - Agents evolve over time using evolutionary algorithms that simulate wealth accumulation and utility optimization.</span>

<span class="sd">   - Agents with higher utility accumulate more wealth and influence the population&#39;s evolution.</span>

<span class="sd">   - Includes features like mutation, agent reproduction, and selection of top-performing agents.</span>

<span class="sd">4. **Processes**:</span>

<span class="sd">   - Agents interact with multiple stochastic processes, such as Geometric Brownian Motion or Geometric LÃ©vy processes, to maximize their wealth.</span>

<span class="sd">   - Agents select and invest in the best process based on expected utility.</span>

<span class="sd">5. **Multi-Agent Simulations**:</span>

<span class="sd">   - The module provides tools to simulate the behavior of a population of agents over multiple time steps.</span>

<span class="sd">   - Agents are removed or duplicated based on their performance, and new agents are created through mutation.</span>

<span class="sd">6. **Visualization**:</span>

<span class="sd">   - Includes tools for visualizing agent evolution, utility function evolution, and other trends over time.</span>

<span class="sd">   - Provides methods to generate animations and CSV logs for post-simulation analysis.</span>

<span class="sd">7. **Support for Numerical and Symbolic Computation**:</span>

<span class="sd">   - Both symbolic and numerical approaches are supported for computing expected utility, offering flexibility in different simulation scenarios.</span>

<span class="sd">8. **Evolution with Multiple Processes**:</span>

<span class="sd">   - Agents can select from multiple stochastic processes, optimizing their utility functions in a diverse environment.</span>

<span class="sd">   - The module supports the creation of multiple stochastic processes and allows agents to interact with them over time.</span>

<span class="sd">Example Usage:</span>

<span class="sd">### Basic Usage of Evolutionary Algorithm:</span>

<span class="sd">from ergodicity.process.multiplicative import GeometricBrownianMotion</span>

<span class="sd">from ergodicity.agents import Agent_utility</span>

<span class="sd"># Define parameters for agents</span>

<span class="sd">param_means = np.array([1.0, 1.0, 0.5, 1.0])</span>

<span class="sd">param_stds = np.array([0.1, 0.1, 0.05, 0.1])</span>

<span class="sd">mutation_rate = 0.01</span>

<span class="sd"># Define a set of stochastic processes</span>

<span class="sd">processes = [</span>
<span class="sd">    GeometricBrownianMotion(drift=0.02, volatility=0.15),</span>
<span class="sd">    GeometricBrownianMotion(drift=0.03, volatility=0.18)</span>
<span class="sd">]</span>

<span class="sd"># Run the evolutionary algorithm</span>

<span class="sd">final_agents, history = Agent_utility.evolutionary_algorithm(</span>
<span class="sd">    n_agents=100,</span>
<span class="sd">    n_steps=1000,</span>
<span class="sd">    save_interval=50,</span>
<span class="sd">    processes=processes,</span>
<span class="sd">    param_means=param_means,</span>
<span class="sd">    param_stds=param_stds,</span>
<span class="sd">    mutation_rate=mutation_rate,</span>
<span class="sd">    stochastic_process_class=GeometricBrownianMotion,</span>
<span class="sd">    keep_top_n=50,</span>
<span class="sd">    removal_interval=10,</span>
<span class="sd">    process_selection_share=0.5</span>
<span class="sd">)</span>

<span class="sd"># Visualize agent evolution</span>

<span class="sd">Agent_utility.visualize_agent_evolution(history)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># from ergodicity.process.multiplicative import GeometricBrownianMotion, GeometricLevyProcess</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sympy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="k">as</span> <span class="nn">animation</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">integrate</span> <span class="k">as</span> <span class="n">scipy_integrate</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">ergodicity.custom_warnings</span> <span class="kn">import</span> <span class="n">InDevelopmentWarning</span>


<div class="viewcode-block" id="general_utility_function">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.general_utility_function">[docs]</a>
<span class="k">def</span> <span class="nf">general_utility_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the utility for a given x and set of parameters.</span>
<span class="sd">    Works with both SymPy symbols and numpy arrays.</span>

<span class="sd">    :param x: Input value or array</span>
<span class="sd">    :type x: Union[float, np.ndarray, sp.Expr, sp.Symbol]</span>
<span class="sd">    :param alpha: Utility function parameter</span>
<span class="sd">    :type alpha: float</span>
<span class="sd">    :param beta: Utility function parameter</span>
<span class="sd">    :type beta: float</span>
<span class="sd">    :param gamma: Utility function parameter</span>
<span class="sd">    :type gamma: float</span>
<span class="sd">    :param delta: Utility function parameter</span>
<span class="sd">    :type delta: float</span>
<span class="sd">    :param epsilon: Utility function parameter</span>
<span class="sd">    :type epsilon: float</span>
<span class="sd">    :return: The calculated utility expression or array</span>
<span class="sd">    :rtype: Union[float, np.ndarray]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="n">gamma</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">))</span> <span class="o">+</span> <span class="n">epsilon</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">gamma</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">))</span> <span class="o">+</span> <span class="n">epsilon</span></div>


<div class="viewcode-block" id="Agent_utility">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Agent_utility</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents an agent with utility-based decision making in stochastic processes.</span>

<span class="sd">    This class implements an agent that can evaluate and interact with various stochastic processes</span>
<span class="sd">    based on a parameterized utility function. It supports both symbolic and numerical methods for</span>
<span class="sd">    calculating expected utilities, and includes evolutionary algorithms for optimizing agent parameters.</span>

<span class="sd">    Attributes:</span>

<span class="sd">        params (np.ndarray): Parameters of the agent&#39;s utility function [alpha, beta, gamma, delta, epsilon].</span>

<span class="sd">        wealth (float): Current wealth of the agent.</span>

<span class="sd">        total_accumulated_wealth (float): Total accumulated wealth of the agent over time.</span>

<span class="sd">    The class provides comprehensive tools for modeling agent behavior in complex stochastic environments,</span>
<span class="sd">    including utility calculation, parameter optimization, and visualization of results. It is particularly</span>
<span class="sd">    useful for studying optimal strategies in financial markets, decision making under uncertainty, and</span>
<span class="sd">    evolutionary dynamics in economic systems.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># [alpha, beta, gamma, delta]</span>
    <span class="n">wealth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">total_accumulated_wealth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># New field to track total wealth</span>

<div class="viewcode-block" id="Agent_utility.expected_utility">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.expected_utility">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">expected_utility</span><span class="p">(</span><span class="n">process_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the expected utility of a process using robust adaptive numerical integration.</span>

<span class="sd">        :param process_dict: Dictionary containing the symbolic function and process parameters</span>
<span class="sd">        :type process_dict: Dict[str, Any]</span>
<span class="sd">        :param params: Parameters of the utility function [alpha, beta, gamma, delta, epsilon]</span>
<span class="sd">        :type params: np.ndarray</span>
<span class="sd">        :param t: Time horizon for the process. If None, returns a function of t.</span>
<span class="sd">        :type t: float</span>
<span class="sd">        :return: Either a function that computes expected utility for any t, or the numerical value for a specific t</span>
<span class="sd">        :rtype: Union[Callable[[float], float], float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">t_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">)</span>
        <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="n">params</span>

        <span class="n">symbolic_func</span> <span class="o">=</span> <span class="n">process_dict</span><span class="p">[</span><span class="s1">&#39;symbolic&#39;</span><span class="p">]</span>
        <span class="n">process_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">process_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;symbolic&#39;</span><span class="p">}</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">symbolic_func</span><span class="p">(</span><span class="n">t_sym</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="o">**</span><span class="n">process_params</span><span class="p">)</span>
        <span class="n">utility</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">general_utility_function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">)</span>
        <span class="n">integrand</span> <span class="o">=</span> <span class="n">utility</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">W</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t_sym</span><span class="p">))</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t_sym</span><span class="p">)</span>
        <span class="n">np_integrand</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">((</span><span class="n">W</span><span class="p">,</span> <span class="n">t_sym</span><span class="p">),</span> <span class="n">integrand</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">expected_utility_for_t</span><span class="p">(</span><span class="n">t_val</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">integrand_for_quad</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">np_integrand</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">t_val</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">result</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">adaptive_integrate</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.49e-8</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">quad_wrapper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">scipy_integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">epsabs</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">200</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">result</span> <span class="o">=</span> <span class="n">quad_wrapper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">10</span>

                <span class="k">while</span> <span class="n">error</span> <span class="o">&gt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">iterations</span> <span class="o">&lt;</span> <span class="n">max_iterations</span><span class="p">:</span>
                    <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">quad_wrapper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="n">quad_wrapper</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                    <span class="n">new_result</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">new_result</span> <span class="o">-</span> <span class="n">result</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">new_result</span>
                    <span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">return</span> <span class="n">result</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">adaptive_integrate</span><span class="p">(</span><span class="n">integrand_for_quad</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Integration result is not finite&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Integration failed for t=</span><span class="si">{</span><span class="n">t_val</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">integrand_for_quad</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trapz integration result is not finite&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fallback integration also failed: </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mf">0.0</span>  <span class="c1"># Return a default value if all integration methods fail</span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="c1"># print(f&quot;Execution time of the symbolic expected utility method: {execution_time:.2f} seconds&quot;)</span>

        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expected_utility_for_t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expected_utility_for_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="Agent_utility.numerical_expected_utility">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.numerical_expected_utility">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">numerical_expected_utility</span><span class="p">(</span><span class="n">process</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                   <span class="n">stochastic_process_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_instances</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate multiple instances of the process and take their average utility to approximate the expected utility.</span>

<span class="sd">        :param process: Either a dictionary containing process parameters or an instance of a stochastic process</span>
<span class="sd">        :type process: Union[Dict[str, Any], object]</span>
<span class="sd">        :param params: Parameters of the utility function [alpha, beta, gamma, delta, epsilon]</span>
<span class="sd">        :type params: np.ndarray</span>
<span class="sd">        :param stochastic_process_class: The class of the stochastic process</span>
<span class="sd">        :type stochastic_process_class: Type</span>
<span class="sd">        :param t: Time horizon for the process. If None, returns a function of t.</span>
<span class="sd">        :type t: float</span>
<span class="sd">        :return: Either a function that computes expected utility for any t, or the numerical value for a specific t</span>
<span class="sd">        :rtype: Union[Callable[[float], float], float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">numerical_expected_utility_for_t</span><span class="p">(</span><span class="n">t_val</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># For dictionary-based processes</span>
                <span class="n">process_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;symbolic&#39;</span><span class="p">}</span>
                <span class="n">process_instance</span> <span class="o">=</span> <span class="n">stochastic_process_class</span><span class="p">(</span><span class="o">**</span><span class="n">process_params</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For direct instances of stochastic processes</span>
                <span class="n">process_instance</span> <span class="o">=</span> <span class="n">process</span>

            <span class="c1"># Simulate the process</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">process_instance</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_val</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">num_instances</span><span class="o">=</span><span class="n">num_instances</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">utility</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">general_utility_function_np</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">utility</span><span class="p">)</span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">execution_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="c1"># print(f&quot;Execution time of the numerical expected utility method: {execution_time:.2f} seconds&quot;)</span>

        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numerical_expected_utility_for_t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numerical_expected_utility_for_t</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="Agent_utility.compare_numerical_and_symbolic_expected_utility">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.compare_numerical_and_symbolic_expected_utility">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compare_numerical_and_symbolic_expected_utility</span><span class="p">(</span><span class="n">process_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                                        <span class="n">stochastic_process_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare the numerical and symbolic expected utility calculations for a given process and parameters.</span>

<span class="sd">        :param process_dict: Dictionary containing the symbolic function and process parameters</span>
<span class="sd">        :type process_dict: Dict[str, Any]</span>
<span class="sd">        :param params: Parameters of the utility function [alpha, beta, gamma, delta, epsilon]</span>
<span class="sd">        :type params: np.ndarray</span>
<span class="sd">        :param stochastic_process_class: The class of the stochastic process</span>
<span class="sd">        :type stochastic_process_class: Type</span>
<span class="sd">        :param t: Time horizon for the process. If None, compares functions instead of specific values.</span>
<span class="sd">        :type t: float</span>
<span class="sd">        :return: None (prints the comparison results)</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symbolic_result</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">expected_utility</span><span class="p">(</span><span class="n">process_dict</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">numerical_result</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">numerical_expected_utility</span><span class="p">(</span><span class="n">process_dict</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">stochastic_process_class</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparing utility functions:&quot;</span><span class="p">)</span>
            <span class="n">test_t_values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>  <span class="c1"># Example t values for comparison</span>
            <span class="k">for</span> <span class="n">test_t</span> <span class="ow">in</span> <span class="n">test_t_values</span><span class="p">:</span>
                <span class="n">sym_value</span> <span class="o">=</span> <span class="n">symbolic_result</span><span class="p">(</span><span class="n">test_t</span><span class="p">)</span>
                <span class="n">num_value</span> <span class="o">=</span> <span class="n">numerical_result</span><span class="p">(</span><span class="n">test_t</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  At t = </span><span class="si">{</span><span class="n">test_t</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Symbolic utility: </span><span class="si">{</span><span class="n">sym_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Numerical utility: </span><span class="si">{</span><span class="n">num_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Difference: </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">sym_value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">num_value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comparing utilities at t = </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Symbolic utility: </span><span class="si">{</span><span class="n">symbolic_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Numerical utility: </span><span class="si">{</span><span class="n">numerical_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Difference: </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">symbolic_result</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">numerical_result</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="c1"># example for GeometricBrownianMotion:</span>
    <span class="c1"># process = GeometricBrownianMotion()</span>
    <span class="c1"># params = np.array([1, 1, 1, 1, 0])</span>
    <span class="c1"># compare_numerical_and_symbolic_expected_utility(process, params, 1.0, GeometricBrownianMotion)</span>

<div class="viewcode-block" id="Agent_utility.general_utility_function">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.general_utility_function">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">general_utility_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Symbolic representation of the general utility function.</span>

<span class="sd">        :param x: The input value</span>
<span class="sd">        :type x: sp.Symbol</span>
<span class="sd">        :param alpha, beta, gamma, delta, epsilon: Utility function parameters</span>
<span class="sd">        :type alpha, beta, gamma, delta, epsilon: float</span>
<span class="sd">        :return: The utility function expression</span>
<span class="sd">        :rtype: sp.Expr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="n">gamma</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">))</span> <span class="o">+</span> <span class="n">epsilon</span></div>


<div class="viewcode-block" id="Agent_utility.general_utility_function_np">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.general_utility_function_np">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">general_utility_function_np</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Numpy version of the general utility function with overflow protection</span>

<span class="sd">        :param x: The input value(s)</span>
<span class="sd">        :type x: Union[float, np.ndarray]</span>
<span class="sd">        :param alpha, beta, gamma, delta, epsilon: Utility function parameters</span>
<span class="sd">        :type alpha, beta, gamma, delta, epsilon: float</span>
<span class="sd">        :return: The utility function value(s)</span>
<span class="sd">        :rtype: Union[float, np.ndarray]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clip extremely large values to prevent overflow</span>
        <span class="n">max_exp</span> <span class="o">=</span> <span class="mi">709</span>  <span class="c1"># np.log(np.finfo(np.float64).max)</span>
        <span class="n">clipped_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_exp</span><span class="p">)</span>
        <span class="n">clipped_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="o">-</span><span class="n">max_exp</span><span class="p">,</span> <span class="n">max_exp</span><span class="p">)</span>
        <span class="n">clipped_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="o">-</span><span class="n">max_exp</span><span class="p">,</span> <span class="n">max_exp</span><span class="p">)</span>

        <span class="n">term1</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">clipped_beta</span> <span class="o">*</span> <span class="n">clipped_x</span> <span class="o">**</span> <span class="n">gamma</span><span class="p">))</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">clipped_delta</span><span class="p">)</span>

        <span class="c1"># Avoid division by zero</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">term2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">term1</span> <span class="o">/</span> <span class="n">term2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span> <span class="o">+</span> <span class="n">epsilon</span></div>


<div class="viewcode-block" id="Agent_utility.visualize_utility_function_evolution">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.visualize_utility_function_evolution">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">visualize_utility_function_evolution</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">output_video_path</span><span class="p">,</span> <span class="n">output_csv_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an animation of the evolution of the best agent&#39;s utility function over time.</span>

<span class="sd">        :param history: List of dictionaries containing step, best_params, and other data</span>
<span class="sd">        :type history: List[Dict[str, Any]]</span>
<span class="sd">        :param output_video_path: Path to save the output video</span>
<span class="sd">        :type output_video_path: str</span>
<span class="sd">        :param output_csv_path: Path to save the output CSV file</span>
<span class="sd">        :type output_csv_path: str</span>
<span class="sd">        :return: None</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Extended range to include negative values</span>

        <span class="c1"># Open the CSV file outside of the animation function</span>
        <span class="n">csvfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_csv_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
        <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Step&#39;</span><span class="p">,</span> <span class="s1">&#39;Alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;Beta&#39;</span><span class="p">,</span> <span class="s1">&#39;Gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;Delta&#39;</span><span class="p">,</span> <span class="s1">&#39;Epsilon&#39;</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;best_params&#39;</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">general_utility_function_np</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best Agent Utility Function - Step </span><span class="si">{</span><span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Utility&#39;</span><span class="p">)</span>

            <span class="c1"># Dynamically set y-axis limits</span>
            <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">y_range</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_min</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">y_range</span><span class="p">)</span>

            <span class="c1"># Add grid for better readability</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

            <span class="c1"># Add legend with parameter values</span>
            <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Î±&#39;</span><span class="p">,</span> <span class="s1">&#39;Î²&#39;</span><span class="p">,</span> <span class="s1">&#39;Î³&#39;</span><span class="p">,</span> <span class="s1">&#39;Î´&#39;</span><span class="p">,</span> <span class="s1">&#39;Îµ&#39;</span><span class="p">]</span>
            <span class="n">legend_text</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">params</span><span class="p">)])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">legend_text</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>

            <span class="c1"># Write to CSV file</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;step&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>

        <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Use a different writer if ffmpeg is not available</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FFMpegWriter</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">artist</span><span class="o">=</span><span class="s1">&#39;Me&#39;</span><span class="p">),</span> <span class="n">bitrate</span><span class="o">=</span><span class="mi">1800</span><span class="p">)</span>
            <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_video_path</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving with FFMpegWriter: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trying to save with PillowWriter...&quot;</span><span class="p">)</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">PillowWriter</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_video_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;.gif&#39;</span><span class="p">),</span> <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="c1"># Close the CSV file after the animation is complete</span>
        <span class="n">csvfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Agent_utility.initialize_agents">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.initialize_agents">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">initialize_agents</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">param_means</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;Agent_utility&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a population of agents with random parameters drawn from normal distributions.</span>

<span class="sd">        :param n: Number of agents to create</span>
<span class="sd">        :type n: int</span>
<span class="sd">        :param param_means: Means of the parameter distributions</span>
<span class="sd">        :type param_means: np.ndarray</span>
<span class="sd">        :param param_stds: Standard deviations of the parameter distributions</span>
<span class="sd">        :type param_stds: np.ndarray</span>
<span class="sd">        :return: List of initialized agents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Agent_utility</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">param_means</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span></div>


<div class="viewcode-block" id="Agent_utility.mutate_params">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.mutate_params">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">mutate_params</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mutate agent parameters for evolutionary algorithms.</span>

<span class="sd">        :param params: Current parameters of the agent</span>
<span class="sd">        :type params: np.ndarray</span>
<span class="sd">        :param mutation_rate: Rate of mutation for the parameters</span>
<span class="sd">        :type mutation_rate: float</span>
<span class="sd">        :return: Mutated parameters</span>
<span class="sd">        :rtype: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mutated_params</span> <span class="o">=</span> <span class="n">params</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mutated_params</span></div>


<div class="viewcode-block" id="Agent_utility.evolutionary_algorithm">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.evolutionary_algorithm">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">evolutionary_algorithm</span><span class="p">(</span><span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">save_interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                               <span class="n">processes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">]],</span>
                               <span class="n">param_means</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                               <span class="n">stochastic_process_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">keep_top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                               <span class="n">removal_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">process_selection_share</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                               <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">process_time</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">numeric_utilities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run an evolutionary algorithm to optimize agent parameters based on expected utility.</span>

<span class="sd">        :param n_agents: Number of agents in the population</span>
<span class="sd">        :type n_agents: int</span>
<span class="sd">        :param n_steps: Number of steps to run the algorithm</span>
<span class="sd">        :type n_steps: int</span>
<span class="sd">        :param save_interval: Interval for saving intermediate results</span>
<span class="sd">        :type save_interval: int</span>
<span class="sd">        :param processes: List of stochastic processes for agents to interact with</span>
<span class="sd">        :type processes: List[Union[dict, object]]</span>
<span class="sd">        :param param_means: Means of the parameter distributions</span>
<span class="sd">        :type param_means: np.ndarray</span>
<span class="sd">        :param param_stds: Standard deviations of the parameter distributions</span>
<span class="sd">        :type param_stds: np.ndarray</span>
<span class="sd">        :param mutation_rate: Rate of mutation for agent parameters</span>
<span class="sd">        :type mutation_rate: float</span>
<span class="sd">        :param stochastic_process_class: Class of the stochastic process (if using dict-based processes)</span>
<span class="sd">        :type stochastic_process_class: Type</span>
<span class="sd">        :param keep_top_n:  Number of top agents to keep after each removal interval</span>
<span class="sd">        :type keep_top_n: int</span>
<span class="sd">        :param removal_interval: Interval for removing agents based on performance (in time units)</span>
<span class="sd">        :type removal_interval: int</span>
<span class="sd">        :param process_selection_share: Share of processes to select for each agent (0 to 1)</span>
<span class="sd">        :type process_selection_share: float</span>
<span class="sd">        :param output_dir: Directory to save output files</span>
<span class="sd">        :type output_dir: str</span>
<span class="sd">        :param process_time: Time horizon for the stochastic processes</span>
<span class="sd">        :type process_time: float</span>
<span class="sd">        :param numeric_utilities: Use numerical utility calculation if True, else use symbolic</span>
<span class="sd">        :type numeric_utilities: bool</span>
<span class="sd">        :raises InDevelopmentWarning: If numeric_utilities is False (feature in development)</span>
<span class="sd">        :return: List of final agents and history of the evolutionary process</span>
<span class="sd">        :rtype: Tuple[List[Agent_utility], List[Dict[str, Any]]]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">numeric_utilities</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InDevelopmentWarning</span><span class="p">(</span><span class="s2">&quot;The feature of the calculation of the expected utility with the integrals of the probability density functions is still in development.&quot;</span>
                                       <span class="s2">&quot;Calculating utilities with the integration of PDFs may deliver incorrect results.&quot;</span>
                                       <span class="s2">&quot;Moreover, for many cases calculation of the expected utility via simulation is faster.&quot;</span>
                                       <span class="s2">&quot;It you still want to use integrals of PDFs, use them with the parameters that are relatively close to 0, because for the large parameters the results diverge from the true values.&quot;</span>
                                       <span class="s2">&quot;We are working on making this feature more accurate and fast.&quot;</span><span class="p">)</span>

        <span class="n">agents</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">initialize_agents</span><span class="p">(</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">param_means</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Ensure output directory exists</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Prepare CSV file for intermediate results</span>
        <span class="n">intermediate_results_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;intermediate_results.csv&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intermediate_results_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;Step&#39;</span><span class="p">,</span> <span class="s1">&#39;Agent_Rank&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Param_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_means</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Total_Wealth&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_steps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Randomly select a subset of processes</span>
            <span class="n">num_processes_to_select</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="o">*</span> <span class="n">process_selection_share</span><span class="p">))</span>
            <span class="n">selected_processes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">num_processes_to_select</span><span class="p">)</span>

            <span class="c1"># Calculate expected utilities for each agent and selected process</span>
            <span class="n">utilities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
                <span class="n">agent_utilities</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">selected_processes</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">numeric_utilities</span><span class="p">:</span>
                            <span class="n">utility</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">numerical_expected_utility</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                                                                               <span class="n">stochastic_process_class</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">process_time</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">process_dict</span> <span class="o">=</span> <span class="n">process_to_dict</span><span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">process</span>
                            <span class="n">utility</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">expected_utility</span><span class="p">(</span><span class="n">process_dict</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">process_time</span><span class="p">)</span>
                        <span class="n">agent_utilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utility</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Utility calculation failed for agent </span><span class="si">{</span><span class="n">agent</span><span class="si">}</span><span class="s2"> and process </span><span class="si">{</span><span class="n">process</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">agent_utilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Assign a default utility if calculation fails</span>
                <span class="n">utilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_utilities</span><span class="p">)</span>

            <span class="c1"># Invest wealth in the best process</span>
            <span class="k">for</span> <span class="n">agent</span><span class="p">,</span> <span class="n">agent_utilities</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">utilities</span><span class="p">):</span>
                <span class="n">best_process_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">agent_utilities</span><span class="p">)</span>
                <span class="n">best_process</span> <span class="o">=</span> <span class="n">selected_processes</span><span class="p">[</span><span class="n">best_process_index</span><span class="p">]</span>

                <span class="c1"># Simulate the stochastic process</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_process</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">stochastic_process_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;stochastic_process_class must be provided when using dict-based processes&quot;</span><span class="p">)</span>
                    <span class="n">process_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">best_process</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;symbolic&#39;</span><span class="p">}</span>
                    <span class="n">process_instance</span> <span class="o">=</span> <span class="n">stochastic_process_class</span><span class="p">(</span><span class="o">**</span><span class="n">process_params</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">process_instance</span> <span class="o">=</span> <span class="n">best_process</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">process_instance</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">process_time</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">num_instances</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Update wealth based on the last value of the process</span>
                <span class="n">process_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Last value of the process</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="o">*=</span> <span class="n">process_value</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="o">*=</span> <span class="n">process_value</span>  <span class="c1"># Update total accumulated wealth</span>

            <span class="c1"># Remove agents with zero or negative wealth</span>
            <span class="n">agents</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span> <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Keep only top n agents every removal_interval steps</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">removal_interval</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There were </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span><span class="si">}</span><span class="s1"> agents.&quot;&#39;</span><span class="p">)</span>
                <span class="n">agents</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">agents</span> <span class="o">=</span> <span class="n">agents</span><span class="p">[:</span><span class="n">keep_top_n</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kept top </span><span class="si">{</span><span class="n">keep_top_n</span><span class="si">}</span><span class="s2"> agents.&quot;</span><span class="p">)</span>

            <span class="c1"># Handle agent splitting</span>
            <span class="n">new_agents</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Create new agent with mutated parameters and half the wealth</span>
                    <span class="n">rounded_wealth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">wealth</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rounded_wealth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">new_agent</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="p">(</span>
                            <span class="n">params</span><span class="o">=</span><span class="n">Agent_utility</span><span class="o">.</span><span class="n">mutate_params</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="p">),</span>
                            <span class="n">wealth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">total_accumulated_wealth</span><span class="o">=</span><span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span>  <span class="c1"># Inherit total wealth</span>
                        <span class="p">)</span>
                        <span class="n">new_agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_agent</span><span class="p">)</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">agents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_agents</span><span class="p">)</span>

            <span class="c1"># Save intermediate data</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">save_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
                    <span class="s1">&#39;n_agents&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">),</span>
                    <span class="s1">&#39;avg_wealth&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">]),</span>
                    <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">)</span><span class="o">.</span><span class="n">params</span>
                <span class="p">})</span>

            <span class="c1"># Save intermediate results every 10 steps</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">agents</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intermediate_results_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">agents</span><span class="p">[:</span><span class="n">keep_top_n</span><span class="p">]):</span>
                        <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">step</span><span class="p">,</span> <span class="n">rank</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">])</span>

            <span class="n">best_agent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best_agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">:</span>
                <span class="c1"># divide all agents&#39; total wealth by 1000000</span>
                <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="o">/=</span> <span class="mi">1000000</span>

        <span class="c1"># Generate visualization after the algorithm completes</span>
        <span class="n">output_video_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;utility_function_evolution.mp4&#39;</span><span class="p">)</span>
        <span class="n">output_csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_agent_parameters.csv&#39;</span><span class="p">)</span>
        <span class="n">Agent_utility</span><span class="o">.</span><span class="n">visualize_utility_function_evolution</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">output_video_path</span><span class="p">,</span> <span class="n">output_csv_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">agents</span><span class="p">,</span> <span class="n">history</span></div>


<div class="viewcode-block" id="Agent_utility.evolutionary_algorithm_with_exchange">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.evolutionary_algorithm_with_exchange">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">evolutionary_algorithm_with_exchange</span><span class="p">(</span><span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">save_interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                             <span class="n">processes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">]],</span>
                                             <span class="n">param_means</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">noise_std</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                             <span class="n">stochastic_process_class</span><span class="p">:</span> <span class="n">Type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                                             <span class="n">process_selection_share</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                                             <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">process_time</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                             <span class="n">numeric_utilities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run an evolutionary algorithm to optimize agent parameters based on expected utility with the exchange of parameters (evolution-like mixing of genetic information).</span>

<span class="sd">        :param n_agents: Number of agents in the population</span>
<span class="sd">        :type n_agents: int</span>
<span class="sd">        :param n_steps: Number of steps to run the algorithm</span>
<span class="sd">        :type n_steps: int</span>
<span class="sd">        :param save_interval: Interval for saving intermediate results</span>
<span class="sd">        :type save_interval: int</span>
<span class="sd">        :param processes: List of stochastic processes for agents to interact with</span>
<span class="sd">        :type processes: List[Union[dict, object]]</span>
<span class="sd">        :param param_means: Means of the parameter distributions</span>
<span class="sd">        :type param_means: np.ndarray</span>
<span class="sd">        :param param_stds: Standard deviations of the parameter distributions</span>
<span class="sd">        :type param_stds: np.ndarray</span>
<span class="sd">        :param noise_std: Standard deviation of the noise added to averaged parameters</span>
<span class="sd">        :type noise_std: float</span>
<span class="sd">        :param stochastic_process_class: The class of the stochastic process (if using dict-based processes)</span>
<span class="sd">        :type stochastic_process_class: Type</span>
<span class="sd">        :param top_k: Number of top agents to keep after each selection interval</span>
<span class="sd">        :type top_k: int</span>
<span class="sd">        :param process_selection_share: Share of processes to select for each agent (0 to 1)</span>
<span class="sd">        :type process_selection_share: float</span>
<span class="sd">        :param output_dir: Directory to save output files</span>
<span class="sd">        :type output_dir: str</span>
<span class="sd">        :param s: Interval for selection, averaging, and multiplication</span>
<span class="sd">        :type s: int</span>
<span class="sd">        :param process_time: Time horizon for the stochastic processes</span>
<span class="sd">        :type process_time: float</span>
<span class="sd">        :param numeric_utilities: Use numerical utility calculation if True, else use symbolic</span>
<span class="sd">        :type numeric_utilities: bool</span>
<span class="sd">        :raises InDevelopmentWarning: If numeric_utilities is False (feature in development)</span>
<span class="sd">        :return: List of final agents and history of the evolutionary process</span>
<span class="sd">        :rtype: Tuple[List[Agent_utility], List[Dict[str, Any]]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agents</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">initialize_agents</span><span class="p">(</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">param_means</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">numeric_utilities</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InDevelopmentWarning</span><span class="p">(</span><span class="s2">&quot;The feature of the calculation of the expected utility with the integrals of the probability density functions is still in development.&quot;</span>
                                       <span class="s2">&quot;Calculating utilities with the integration of PDFs may deliver incorrect results.&quot;</span>
                                       <span class="s2">&quot;Moreover, for many cases calculation of the expected utility via simulation is faster.&quot;</span>
                                       <span class="s2">&quot;It you still want to use integrals of PDFs, use them with the parameters that are relatively close to 0, because for the large parameters the results diverge from the true values.&quot;</span>
                                       <span class="s2">&quot;We are working on making this feature more accurate and fast.&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure output directory exists</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Prepare CSV file for intermediate results</span>
        <span class="n">intermediate_results_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;intermediate_results.csv&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intermediate_results_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;Step&#39;</span><span class="p">,</span> <span class="s1">&#39;Agent_Rank&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Param_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_means</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Total_Wealth&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_steps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Randomly select a subset of processes</span>
            <span class="n">num_processes_to_select</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="o">*</span> <span class="n">process_selection_share</span><span class="p">))</span>
            <span class="n">selected_processes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">num_processes_to_select</span><span class="p">)</span>

            <span class="c1"># Calculate expected utilities for each agent and selected process</span>
            <span class="n">utilities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
                <span class="n">agent_utilities</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">selected_processes</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">numeric_utilities</span><span class="p">:</span>
                            <span class="n">utility</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">numerical_expected_utility</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                                                                               <span class="n">stochastic_process_class</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">process_time</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">process_dict</span> <span class="o">=</span> <span class="n">process_to_dict</span><span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">process</span>
                            <span class="n">utility</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">expected_utility</span><span class="p">(</span><span class="n">process_dict</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">process_time</span><span class="p">)</span>
                        <span class="n">agent_utilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utility</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Utility calculation failed for agent </span><span class="si">{</span><span class="n">agent</span><span class="si">}</span><span class="s2"> and process </span><span class="si">{</span><span class="n">process</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">agent_utilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Assign a default utility if calculation fails</span>
                <span class="n">utilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_utilities</span><span class="p">)</span>

            <span class="c1"># Invest wealth in the best process</span>
            <span class="k">for</span> <span class="n">agent</span><span class="p">,</span> <span class="n">agent_utilities</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">utilities</span><span class="p">):</span>
                <span class="n">best_process_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">agent_utilities</span><span class="p">)</span>
                <span class="n">best_process</span> <span class="o">=</span> <span class="n">selected_processes</span><span class="p">[</span><span class="n">best_process_index</span><span class="p">]</span>

                <span class="c1"># Simulate the stochastic process</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_process</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">stochastic_process_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;stochastic_process_class must be provided when using dict-based processes&quot;</span><span class="p">)</span>
                    <span class="n">process_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">best_process</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;symbolic&#39;</span><span class="p">]}</span>
                    <span class="n">process_instance</span> <span class="o">=</span> <span class="n">stochastic_process_class</span><span class="p">(</span><span class="o">**</span><span class="n">process_params</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">process_instance</span> <span class="o">=</span> <span class="n">best_process</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">process_instance</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">process_time</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">num_instances</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Update wealth based on the last value of the process</span>
                <span class="n">process_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Last value of the process</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="o">*=</span> <span class="n">process_value</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="o">*=</span> <span class="n">process_value</span>  <span class="c1"># Update total accumulated wealth</span>

            <span class="c1"># Remove agents with zero or negative wealth</span>
            <span class="n">agents</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span> <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Perform selection, averaging, and multiplication every s steps</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Total wealth of all agents</span>
                <span class="n">total_wealth</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total wealth: </span><span class="si">{</span><span class="n">total_wealth</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># Sort agents by total accumulated wealth</span>
                <span class="n">agents</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Select top k agents</span>
                <span class="n">top_agents</span> <span class="o">=</span> <span class="n">agents</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]</span>

                <span class="c1"># Calculate average parameters of top k agents</span>
                <span class="n">avg_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">params</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">top_agents</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Create new generation with noise added to averaged parameters</span>
                <span class="n">new_agents</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_agents</span><span class="p">):</span>
                    <span class="n">new_params</span> <span class="o">=</span> <span class="n">avg_params</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_std</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">avg_params</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">new_agent</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">new_params</span><span class="p">,</span> <span class="n">wealth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">total_accumulated_wealth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">new_agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_agent</span><span class="p">)</span>

                <span class="n">agents</span> <span class="o">=</span> <span class="n">new_agents</span>

            <span class="c1"># Save intermediate data</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">save_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
                    <span class="s1">&#39;n_agents&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">),</span>
                    <span class="s1">&#39;avg_wealth&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">]),</span>
                    <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">)</span><span class="o">.</span><span class="n">params</span>
                <span class="p">})</span>

            <span class="c1"># Save intermediate results every 10 steps</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">agents</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intermediate_results_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">agents</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]):</span>
                        <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">step</span><span class="p">,</span> <span class="n">rank</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">])</span>

            <span class="n">best_agent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best_agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">:</span>
                <span class="c1"># divide all agents&#39; total wealth by 1000000</span>
                <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="o">/=</span> <span class="mi">1000000</span>

        <span class="c1"># Generate visualization after the algorithm completes</span>
        <span class="n">output_video_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;utility_function_evolution.mp4&#39;</span><span class="p">)</span>
        <span class="n">output_csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_agent_parameters.csv&#39;</span><span class="p">)</span>
        <span class="n">Agent_utility</span><span class="o">.</span><span class="n">visualize_utility_function_evolution</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">output_video_path</span><span class="p">,</span> <span class="n">output_csv_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">agents</span><span class="p">,</span> <span class="n">history</span></div>


<div class="viewcode-block" id="Agent_utility.evolutionary_algorithm_with_multiple_processes">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.Agent_utility.evolutionary_algorithm_with_multiple_processes">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">evolutionary_algorithm_with_multiple_processes</span><span class="p">(</span>
            <span class="n">n_agents</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">save_interval</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">processes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">]],</span>
            <span class="n">param_means</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="n">mutation_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">keep_top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">removal_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">process_selection_share</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
            <span class="n">process_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">numeric_utilities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run an evolutionary algorithm to optimize agent parameters based on expected utility with multiple process types.</span>

<span class="sd">        :param n_agents: Number of agents in the population</span>
<span class="sd">        :type n_agents: int</span>
<span class="sd">        :param n_steps: Number of steps to run the algorithm</span>
<span class="sd">        :type n_steps: int</span>
<span class="sd">        :param save_interval: Interval for saving intermediate results</span>
<span class="sd">        :type save_interval: int</span>
<span class="sd">        :param processes: List of stochastic processes for agents to interact with</span>
<span class="sd">        :type processes: List[Union[dict, object]]</span>
<span class="sd">        :param param_means: Means of the parameter distributions</span>
<span class="sd">        :type param_means: np.ndarray</span>
<span class="sd">        :param param_stds: Standard deviations of the parameter distributions</span>
<span class="sd">        :type param_stds: np.ndarray</span>
<span class="sd">        :param mutation_rate: Rate of mutation for agent parameters</span>
<span class="sd">        :type mutation_rate: float</span>
<span class="sd">        :param keep_top_n: Number of top agents to keep after each removal interval</span>
<span class="sd">        :type keep_top_n: int</span>
<span class="sd">        :param removal_interval: Interval for removing agents based on performance (in time units)</span>
<span class="sd">        :type removal_interval: int</span>
<span class="sd">        :param process_selection_share: Share of processes to select for each agent (0 to 1)</span>
<span class="sd">        :type process_selection_share: float</span>
<span class="sd">        :param output_dir: Directory to save output files</span>
<span class="sd">        :type output_dir: str</span>
<span class="sd">        :param process_time: Time horizon for the stochastic processes</span>
<span class="sd">        :type process_time: float</span>
<span class="sd">        :param numeric_utilities: Use numerical utility calculation if True, else use symbolic</span>
<span class="sd">        :type numeric_utilities: bool</span>
<span class="sd">        :raises InDevelopmentWarning: If numeric_utilities is False (feature in development)</span>
<span class="sd">        :return: List of final agents and history of the evolutionary process</span>
<span class="sd">        :rtype: Tuple[List[Agent_utility], List[Dict[str, Any]]]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">numeric_utilities</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InDevelopmentWarning</span><span class="p">(</span><span class="s2">&quot;The feature of the calculation of the expected utility with the integrals of the probability density functions is still in development.&quot;</span>
                                       <span class="s2">&quot;Calculating utilities with the integration of PDFs may deliver incorrect results.&quot;</span>
                                       <span class="s2">&quot;Moreover, for many cases calculation of the expected utility via simulation is faster.&quot;</span>
                                       <span class="s2">&quot;It you still want to use integrals of PDFs, use them with the parameters that are relatively close to 0, because for the large parameters the results diverge from the true values.&quot;</span>
                                       <span class="s2">&quot;We are working on making this feature more accurate and fast.&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">initialize_agents</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">param_means</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;Agent_utility&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Agent_utility</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">param_means</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

        <span class="k">def</span> <span class="nf">mutate_params</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">params</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="n">agents</span> <span class="o">=</span> <span class="n">initialize_agents</span><span class="p">(</span><span class="n">n_agents</span><span class="p">,</span> <span class="n">param_means</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">intermediate_results_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;intermediate_results.csv&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intermediate_results_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Step&#39;</span><span class="p">,</span> <span class="s1">&#39;Agent_Rank&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">param_means</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">header</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;Param_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
            <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Total_Wealth&#39;</span><span class="p">)</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_steps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">num_processes_to_select</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="o">*</span> <span class="n">process_selection_share</span><span class="p">))</span>
            <span class="n">selected_processes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">num_processes_to_select</span><span class="p">)</span>

            <span class="n">utilities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
                <span class="n">agent_utilities</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">selected_processes</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">numeric_utilities</span><span class="p">:</span>
                            <span class="n">utility</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">numerical_expected_utility</span><span class="p">(</span>
                                <span class="n">process</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">t</span><span class="o">=</span><span class="n">process_time</span><span class="p">,</span> <span class="n">num_instances</span> <span class="o">=</span> <span class="mi">10000</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">process_dict</span> <span class="o">=</span> <span class="n">process_to_dict</span><span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">process</span>
                            <span class="n">utility</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">expected_utility</span><span class="p">(</span>
                                <span class="n">process_dict</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">process_time</span>
                            <span class="p">)</span>
                        <span class="n">agent_utilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utility</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Utility calculation failed for agent </span><span class="si">{</span><span class="n">agent</span><span class="si">}</span><span class="s2"> and process </span><span class="si">{</span><span class="n">process</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">agent_utilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">utilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent_utilities</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">agent</span><span class="p">,</span> <span class="n">agent_utilities</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">utilities</span><span class="p">):</span>
                <span class="n">best_process_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">agent_utilities</span><span class="p">)</span>
                <span class="n">best_process</span> <span class="o">=</span> <span class="n">selected_processes</span><span class="p">[</span><span class="n">best_process_index</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_process</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">process_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">best_process</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;symbolic&#39;</span><span class="p">}</span>
                    <span class="n">process_instance</span> <span class="o">=</span> <span class="n">best_process</span><span class="p">[</span><span class="s1">&#39;symbolic&#39;</span><span class="p">](</span><span class="o">**</span><span class="n">process_params</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">process_instance</span> <span class="o">=</span> <span class="n">best_process</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">process_instance</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">process_time</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">num_instances</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">process_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="o">*=</span> <span class="n">process_value</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="o">*=</span> <span class="n">process_value</span>

            <span class="n">agents</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span> <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">removal_interval</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There were </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span><span class="si">}</span><span class="s1"> agents.&#39;</span><span class="p">)</span>
                <span class="n">agents</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">agents</span> <span class="o">=</span> <span class="n">agents</span><span class="p">[:</span><span class="n">keep_top_n</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kept top </span><span class="si">{</span><span class="n">keep_top_n</span><span class="si">}</span><span class="s2"> agents.&quot;</span><span class="p">)</span>

            <span class="n">new_agents</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">rounded_wealth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">wealth</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rounded_wealth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">new_agent</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="p">(</span>
                            <span class="n">params</span><span class="o">=</span><span class="n">mutate_params</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">new_agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span>
                        <span class="n">new_agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_agent</span><span class="p">)</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">agents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_agents</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">save_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;step&#39;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
                    <span class="s1">&#39;n_agents&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">),</span>
                    <span class="s1">&#39;avg_wealth&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">wealth</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">]),</span>
                    <span class="s1">&#39;best_params&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">)</span><span class="o">.</span><span class="n">params</span>
                <span class="p">})</span>

            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">agents</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intermediate_results_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">agents</span><span class="p">[:</span><span class="n">keep_top_n</span><span class="p">]):</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span><span class="p">,</span> <span class="n">rank</span><span class="p">]</span>
                        <span class="n">row</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
                        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">)</span>
                        <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

            <span class="n">best_agent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best_agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">:</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span> <span class="o">/=</span> <span class="mi">1000000</span>

        <span class="n">output_video_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;utility_function_evolution.mp4&#39;</span><span class="p">)</span>
        <span class="n">output_csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;best_agent_parameters.csv&#39;</span><span class="p">)</span>
        <span class="n">Agent_utility</span><span class="o">.</span><span class="n">visualize_utility_function_evolution</span><span class="p">(</span><span class="n">history</span><span class="p">,</span> <span class="n">output_video_path</span><span class="p">,</span> <span class="n">output_csv_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">agents</span><span class="p">,</span> <span class="n">history</span></div>
</div>


<div class="viewcode-block" id="visualize_agent_evolution">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.visualize_agent_evolution">[docs]</a>
<span class="k">def</span> <span class="nf">visualize_agent_evolution</span><span class="p">(</span><span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize the evolution of top agents and their utility functions.</span>

<span class="sd">    :param history: List of dictionaries containing historical data</span>
<span class="sd">    :type history: List[Dict]</span>
<span class="sd">    :param top_n: Number of top agents to visualize</span>
<span class="sd">    :type top_n: int</span>
<span class="sd">    :return: None (displays plots)</span>
<span class="sd">    :rtype: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history</span><span class="p">]</span>

    <span class="c1"># Plot average wealth over time</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;avg_wealth&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Average Wealth Over Time&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average Wealth&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Plot number of agents over time</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;n_agents&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Number of Agents Over Time&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Agents&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Visualize utility functions of top agents</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;best_params&#39;</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">x_sym</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># If params is a 1D array, it&#39;s for a single agent</span>
        <span class="n">symbolic_utility</span> <span class="o">=</span> <span class="n">general_utility_function</span><span class="p">(</span><span class="n">x_sym</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">numeric_utility</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">x_sym</span><span class="p">,</span> <span class="n">symbolic_utility</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">numeric_utility</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Best Agent&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If params is a 2D array, it&#39;s for multiple agents</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">top_n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))):</span>
            <span class="n">symbolic_utility</span> <span class="o">=</span> <span class="n">general_utility_function</span><span class="p">(</span><span class="n">x_sym</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">numeric_utility</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">(</span><span class="n">x_sym</span><span class="p">,</span> <span class="n">symbolic_utility</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">numeric_utility</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Agent </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Utility Functions of Top Agents&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Utility&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Analyze parameter trends</span>
    <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">,</span> <span class="s1">&#39;epsilon&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;best_params&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;best_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># If best_params is a 1D array, it&#39;s for a single agent</span>
        <span class="n">param_trends</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;best_params&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span>
                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If best_params is a 2D array, take the parameters of the best agent</span>
        <span class="n">param_trends</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;best_params&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span>
                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">)}</span>

    <span class="c1"># Create a 3x2 grid of subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_trends</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> Over Time&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Remove the empty subplot</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="recursive_flatten">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.recursive_flatten">[docs]</a>
<span class="k">def</span> <span class="nf">recursive_flatten</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursively flatten any nested structure into a 1D list of floats.</span>

<span class="sd">    :param data: Nested structure to flatten</span>
<span class="sd">    :type data: Any</span>
<span class="sd">    :return: 1D list of floats</span>
<span class="sd">    :rtype: List[float]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">recursive_flatten</span><span class="p">(</span><span class="n">sublist</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected data type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="analyze_utility_function_trends">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.analyze_utility_function_trends">[docs]</a>
<span class="k">def</span> <span class="nf">analyze_utility_function_trends</span><span class="p">(</span><span class="n">history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">num_agents</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze and visualize trends in the utility functions&#39; evolutionary dynamics.</span>

<span class="sd">    :param history: List of dictionaries containing historical data</span>
<span class="sd">    :type history: List[Dict]</span>
<span class="sd">    :param num_agents: Maximum number of top agents to analyze</span>
<span class="sd">    :type num_agents: int</span>
<span class="sd">    :return: None (displays plots)</span>
<span class="sd">    :rtype: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">history</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: History is empty.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">,</span> <span class="s1">&#39;epsilon&#39;</span><span class="p">]</span>
    <span class="n">param_trends</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;best_params&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: &#39;best_params&#39; not found in history entry: </span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">best_params</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;best_params&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">best_params</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="n">best_params</span><span class="p">[:</span><span class="n">num_agents</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">best_params</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="n">best_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">best_params</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Unexpected type for best_params: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">best_params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">best_params</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
                    <span class="n">param_trends</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Parameter </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> not found in entry: </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Param trends structure:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">trend</span> <span class="ow">in</span> <span class="n">param_trends</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trend</span><span class="p">)</span><span class="si">}</span><span class="s2"> entries, types: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">trend</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Visualize parameter distributions over time</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_trends</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> Distribution Over Time&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Step&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Analyze parameter correlations</span>
    <span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">([</span><span class="n">param_trends</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">param_names</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Parameter Correlations&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Analyze parameter convergence</span>
    <span class="c1"># plt.figure(figsize=(12, 6))</span>
    <span class="c1"># for name, values in param_trends.items():</span>
    <span class="c1">#     stds = np.std(values, axis=0)</span>
    <span class="c1">#     plt.plot(stds, label=name)</span>
    <span class="c1"># plt.title(&#39;Parameter Convergence&#39;)</span>
    <span class="c1"># plt.xlabel(&#39;Step&#39;)</span>
    <span class="c1"># plt.ylabel(&#39;Standard Deviation&#39;)</span>
    <span class="c1"># plt.legend()</span>
    <span class="c1"># plt.show()</span>

    <span class="c1"># Analyze utility function diversity</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="c1"># diversity = []</span>
    <span class="c1"># for entry in history:</span>
    <span class="c1">#     params = entry[&#39;best_params&#39;]</span>
    <span class="c1">#     if isinstance(params, np.ndarray) and params.ndim &gt; 1:</span>
    <span class="c1">#         params = params[:num_agents]</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         params = [params]</span>
    <span class="c1">#     utilities = [Agent_utility.general_utility_function_np(x, *p) for p in params]</span>
    <span class="c1">#     diversity.append(np.mean(np.std(utilities, axis=0)) if len(utilities) &gt; 1 else 0)</span>
    <span class="c1">#</span>
    <span class="c1"># plt.figure(figsize=(12, 6))</span>
    <span class="c1"># plt.plot(range(len(history)), diversity)</span>
    <span class="c1"># plt.title(&#39;Utility Function Diversity Over Time&#39;)</span>
    <span class="c1"># plt.xlabel(&#39;Step&#39;)</span>
    <span class="c1"># plt.ylabel(&#39;Average Standard Deviation of Utilities&#39;)</span>
    <span class="c1"># plt.show()</span>

    <span class="c1"># Visualize final utility functions</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">final_params</span> <span class="o">=</span> <span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;best_params&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">final_params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">final_params</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">final_params</span> <span class="o">=</span> <span class="n">final_params</span><span class="p">[:</span><span class="n">num_agents</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">final_params</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">final_params</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">general_utility_function_np</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Agent </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Final Utility Functions&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Utility&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="process_to_dict">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.process_to_dict">[docs]</a>
<span class="k">def</span> <span class="nf">process_to_dict</span><span class="p">(</span><span class="n">process</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a process object with a closed_formula method to a dictionary format</span>
<span class="sd">    compatible with Agent_utility.compare_numerical_and_symbolic_expected_utility.</span>

<span class="sd">    :param process: An object with a closed_formula method</span>
<span class="sd">    :type process: Any</span>
<span class="sd">    :return: A dictionary with &#39;symbolic&#39; key for the formula and additional keys for process parameters</span>
<span class="sd">    :rtype: Dict[str, Any]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="s1">&#39;closed_formula&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;The provided process object does not have a closed_formula method&quot;</span><span class="p">)</span>

    <span class="n">formula</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">closed_formula</span><span class="p">()</span>

    <span class="c1"># print(f&#39;formula: {formula}&#39;)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>

    <span class="c1"># Create symbolic parameters</span>
    <span class="n">param_symbols</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">}</span>
    <span class="c1"># create a tuple with parameter symbols</span>
    <span class="n">param_symbols_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">param_symbols</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="c1"># print(f&#39;param_symbols: {param_symbols}&#39;)</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;t W&#39;</span><span class="p">)</span>

    <span class="c1"># Call the formula with symbolic parameters</span>
    <span class="n">symbolic_result</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
    <span class="c1"># print(&#39;symbolic_result:&#39;, symbolic_result)</span>

    <span class="c1"># Replace the process attributes with symbolic parameters</span>
    <span class="c1"># for param, symbol in param_symbols.items():</span>
    <span class="c1">#     symbolic_result = symbolic_result.subs(getattr(process, f&quot;_{param}&quot;), symbol)</span>

    <span class="c1"># print(f&#39;parameter symbol values: {list(param_symbols.values())}&#39;)</span>

    <span class="c1"># Create the lambda function using SymPy&#39;s lambdify</span>
    <span class="n">lambda_func</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">W</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_symbols</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">symbolic_result</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sympy&#39;</span><span class="p">])</span>

    <span class="c1"># Create the dictionary</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;symbolic&#39;</span><span class="p">:</span> <span class="n">lambda_func</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Add process parameters to the dictionary</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="generate_processes">
<a class="viewcode-back" href="../../../ergodicity.agents.html#ergodicity.agents.agents.generate_processes">[docs]</a>
<span class="k">def</span> <span class="nf">generate_processes</span><span class="p">(</span><span class="n">num_processes</span><span class="p">,</span> <span class="n">process_types</span><span class="p">,</span> <span class="n">param_ranges</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a list of stochastic processes.</span>

<span class="sd">    :param num_processes: Number of processes to generate</span>
<span class="sd">    :type num_processes: int</span>
<span class="sd">    :param process_types: List of process classes or functions to use</span>
<span class="sd">    :type process_types: list</span>
<span class="sd">    :param param_ranges: Dictionary of parameter ranges for each process type</span>
<span class="sd">    :type param_ranges: dict</span>
<span class="sd">    :return: List of generated processes</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">):</span>
        <span class="c1"># Randomly select a process type</span>
        <span class="n">process_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">process_types</span><span class="p">)</span>

        <span class="c1"># Generate parameters for the selected process type</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">range_values</span> <span class="ow">in</span> <span class="n">param_ranges</span><span class="p">[</span><span class="n">process_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">range_values</span><span class="p">)</span>

        <span class="c1"># Create the process instance</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="c1"># If it&#39;s a class, instantiate it</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">process_type</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If it&#39;s a function, create a dictionary with the function and its params</span>
            <span class="n">process</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;symbolic&#39;</span><span class="p">:</span> <span class="n">process_type</span><span class="p">,</span>
                <span class="o">**</span><span class="n">params</span>
            <span class="p">}</span>

        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span><span class="si">}</span><span class="s2"> processes&quot;</span><span class="p">)</span>  <span class="c1"># Debug print</span>
    <span class="k">return</span> <span class="n">processes</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Example usage with multiple processes</span>
    <span class="kn">from</span> <span class="nn">ergodicity.process.multiplicative</span> <span class="kn">import</span> <span class="n">GeometricBrownianMotion</span><span class="p">,</span> <span class="n">GeometricLevyProcess</span>

    <span class="n">n_agents</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">n_steps</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">save_interval</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">removal_percentage</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Remove 10% of worst-performing agents</span>
    <span class="n">removal_interval</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Remove agents every 10 steps</span>

    <span class="c1"># Generate multiple processes with varying parameters</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">GeometricBrownianMotion</span><span class="p">(</span><span class="n">drift</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="mf">0.15</span><span class="p">),</span>
        <span class="n">GeometricBrownianMotion</span><span class="p">(</span><span class="n">drift</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="mf">0.18</span><span class="p">),</span>
        <span class="n">GeometricBrownianMotion</span><span class="p">(</span><span class="n">drift</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="mf">0.12</span><span class="p">),</span>
        <span class="n">GeometricBrownianMotion</span><span class="p">(</span><span class="n">drift</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="mf">0.20</span><span class="p">),</span>
        <span class="n">GeometricBrownianMotion</span><span class="p">(</span><span class="n">drift</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span> <span class="n">volatility</span><span class="o">=</span><span class="mf">0.10</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">param_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">param_stds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
    <span class="n">mutation_rate</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="n">final_agents</span><span class="p">,</span> <span class="n">history</span> <span class="o">=</span> <span class="n">Agent_utility</span><span class="o">.</span><span class="n">evolutionary_algorithm</span><span class="p">(</span>
        <span class="n">n_agents</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">save_interval</span><span class="p">,</span> <span class="n">processes</span><span class="p">,</span>
        <span class="n">param_means</span><span class="p">,</span> <span class="n">param_stds</span><span class="p">,</span> <span class="n">mutation_rate</span><span class="p">,</span>
        <span class="n">GeometricBrownianMotion</span><span class="p">,</span>
        <span class="n">keep_top_n</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="c1"># Specify the number of top agents to keep</span>
        <span class="n">removal_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">process_selection_share</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="p">)</span>

    <span class="c1"># Print some results</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of agents at the end: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">final_agents</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average wealth at the end: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">agent</span><span class="o">.</span><span class="n">wealth</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">agent</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">final_agents</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">best_agent</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">final_agents</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best agent&#39;s wealth: </span><span class="si">{</span><span class="n">best_agent</span><span class="o">.</span><span class="n">wealth</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best agent&#39;s total accumulated wealth: </span><span class="si">{</span><span class="n">best_agent</span><span class="o">.</span><span class="n">total_accumulated_wealth</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best agent&#39;s parameters: </span><span class="si">{</span><span class="n">best_agent</span><span class="o">.</span><span class="n">params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Example usage:</span>
    <span class="c1"># Assuming you have run the evolutionary algorithm and obtained the history</span>
    <span class="n">visualize_agent_evolution</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
    <span class="n">analyze_utility_function_trends</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Ergodicity Library</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Ihor Kendiukhov.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>